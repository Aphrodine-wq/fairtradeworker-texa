import { useState } from 'react'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Textarea } from '@/components/ui/textarea'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog'
import { Badge } from '@/components/ui/badge'
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table'
import { Plus, Trash, Receipt, CurrencyDollar, Wrench, HardHat, Truck, FileText, Car, Package
} from '@phosphor-icons/react'
import type { Milestone, MilestoneExpense } from '@/lib/types'
import { toast } from 'sonner' interface ExpenseTrackingProps { milestone: Milestone onUpdateMilestone: (milestone: Milestone) => void canEdit: boolean
} const categoryIcons: Record<MilestoneExpense['category'], any> = { materials: Package, labor: HardHat, equipment: Wrench, permits: FileText, travel: Car, other: Receipt
} const categoryColors: Record<MilestoneExpense['category'], string> = { materials: 'bg-blue-100 text-blue-700 border-blue-300', labor: 'bg-purple-100 text-purple-700 border-purple-300', equipment: 'bg-orange-100 text-orange-700 border-orange-300', permits: 'bg-green-100 text-green-700 border-green-300', travel: 'bg-yellow-100 text-yellow-700 border-yellow-300', other: 'bg-gray-100 text-gray-700 border-gray-300'
} export function ExpenseTracking({ milestone, onUpdateMilestone, canEdit }: ExpenseTrackingProps) { const [showAddDialog, setShowAddDialog] = useState(false) const [receiptPreview, setReceiptPreview] = useState<string | null>(null) const [formData, setFormData] = useState<Partial<MilestoneExpense>>({ category: 'materials', description: '', amount: 0, quantity: 1, unitCost: 0, vendor: '', notes: '', date: new Date().toISOString().split('T')[0] }) const expenses = milestone.expenses || [] const totalExpenses = expenses.reduce((sum, exp) => sum + exp.amount, 0) const budgetRemaining = milestone.amount - totalExpenses const budgetPercentUsed = (totalExpenses / milestone.amount) * 100 const expensesByCategory = expenses.reduce((acc, exp) => { acc[exp.category] = (acc[exp.category] || 0) + exp.amount return acc }, {} as Record<MilestoneExpense['category'], number>) const handleFileUpload = (e: React.ChangeEvent<HTMLInputElement>) => { const file = e.target.files?.[0] if (!file) return const reader = new FileReader() reader.onloadend = () => { setReceiptPreview(reader.result as string) setFormData(prev => ({ ...prev, receiptPhoto: reader.result as string })) } reader.readAsDataURL(file) } const handleAddExpense = () => { if (!formData.description?.trim()) { toast.error('Please enter a description') return } if (!formData.amount || formData.amount <= 0) { toast.error('Please enter a valid amount') return } const newExpense: MilestoneExpense = { id: `exp-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`, milestoneId: milestone.id, category: formData.category as MilestoneExpense['category'], description: formData.description, amount: formData.amount, quantity: formData.quantity, unitCost: formData.unitCost, vendor: formData.vendor, receiptPhoto: formData.receiptPhoto, date: formData.date || new Date().toISOString().split('T')[0], notes: formData.notes } const updatedMilestone = { ...milestone, expenses: [...expenses, newExpense] } onUpdateMilestone(updatedMilestone) setShowAddDialog(false) resetForm() toast.success('Expense added') } const handleDeleteExpense = (expenseId: string) => { const updatedMilestone = { ...milestone, expenses: expenses.filter(exp => exp.id !== expenseId) } onUpdateMilestone(updatedMilestone) toast.success('Expense deleted') } const resetForm = () => { setFormData({ category: 'materials', description: '', amount: 0, quantity: 1, unitCost: 0, vendor: '', notes: '', date: new Date().toISOString().split('T')[0] }) setReceiptPreview(null) } const updateQuantity = (qty: number) => { const unitCost = formData.unitCost || 0 setFormData(prev => ({ ...prev, quantity: qty, amount: qty * unitCost })) } const updateUnitCost = (cost: number) => { const quantity = formData.quantity || 1 setFormData(prev => ({ ...prev, unitCost: cost, amount: quantity * cost })) } return ( <div className="space-y-6"> <Card> <CardHeader> <div className="flex items-center justify-between"> <div> <CardTitle className="flex items-center gap-2"> <CurrencyDollar size={24} weight="bold" /> Expense Tracking </CardTitle> <CardDescription> Track materials, labor, and other costs for this milestone </CardDescription> </div> {canEdit && ( <Dialog open={showAddDialog} onOpenChange={setShowAddDialog}> <DialogTrigger asChild> <Button size="sm"> <Plus size={16} weight="bold" className="mr-2" /> Add Expense </Button> </DialogTrigger> <DialogContent className="overflow-hidden flex flex-col p-0 gap-0 h-[95vh]"> <div className="px-8 pt-6 pb-4 border-2 border-black dark:border-white flex-shrink-0"> <DialogHeader className="text-left"> <DialogTitle className="text-2xl">Add Expense</DialogTitle> <DialogDescription> Log a new expense for this milestone </DialogDescription> </DialogHeader> </div> <div className="flex-1 overflow-hidden p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"> {/* Left Column */} <div className="space-y-4"> <div> <Label htmlFor="category" className="text-base">Category</Label> <Select value={formData.category} onValueChange={(value) => setFormData(prev => ({ ...prev, category: value as MilestoneExpense['category'] }))} > <SelectTrigger id="category" className="h-11"> <SelectValue /> </SelectTrigger> <SelectContent> <SelectItem value="materials">Materials</SelectItem> <SelectItem value="labor">Labor</SelectItem> <SelectItem value="equipment">Equipment</SelectItem> <SelectItem value="permits">Permits</SelectItem> <SelectItem value="travel">Travel</SelectItem> <SelectItem value="other">Other</SelectItem> </SelectContent> </Select> </div> <div> <Label htmlFor="description" className="text-base">Description *</Label> <Input id="description" placeholder="e.g., 2x4 lumber, paint, electrician labor" value={formData.description} onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))} className="h-11" /> </div> <div> <Label htmlFor="vendor" className="text-base">Vendor</Label> <Input id="vendor" placeholder="e.g., Home Depot, Lowe's" value={formData.vendor} onChange={(e) => setFormData(prev => ({ ...prev, vendor: e.target.value }))} className="h-11" /> </div> </div> {/* Middle Column */} <div className="space-y-4"> <div> <Label htmlFor="quantity" className="text-base">Quantity</Label> <Input id="quantity" type="number" min="0" step="0.01" value={formData.quantity} onChange={(e) => updateQuantity(parseFloat(e.target.value) || 0)} className="h-11" /> </div> <div> <Label htmlFor="unitCost" className="text-base">Unit Cost</Label> <Input id="unitCost" type="number" min="0" step="0.01" placeholder="0.00" value={formData.unitCost} onChange={(e) => updateUnitCost(parseFloat(e.target.value) || 0)} className="h-11" /> </div> <div> <Label htmlFor="amount" className="text-base">Total Amount *</Label> <Input id="amount" type="number" min="0" step="0.01" placeholder="0.00" value={formData.amount} onChange={(e) => setFormData(prev => ({ ...prev, amount: parseFloat(e.target.value) || 0 }))} className="h-11" /> </div> <div> <Label htmlFor="date" className="text-base">Date</Label> <Input id="date" type="date" value={formData.date} onChange={(e) => setFormData(prev => ({ ...prev, date: e.target.value }))} className="h-11" /> </div> </div> {/* Right Column */} <div className="space-y-4"> <div> <Label htmlFor="notes" className="text-base">Notes</Label> <Textarea id="notes" placeholder="Additional details about this expense" value={formData.notes} onChange={(e) => setFormData(prev => ({ ...prev, notes: e.target.value }))} className="flex-1 resize-none" /> </div> <div> <Label htmlFor="receipt" className="text-base">Receipt Photo (Optional)</Label> <div className="mt-2"> <Input id="receipt" type="file" accept="image/*" onChange={handleFileUpload} className="h-11" /> {receiptPreview && ( <div className="mt-2"> <img src={receiptPreview} alt="Receipt preview" className="w-full rounded border" /> </div> )} </div> </div> </div> </div> <div className="px-8 py-4 border-2 border-black dark:border-white flex-shrink-0"> <div className="flex justify-end gap-3"> <Button variant="outline" onClick={() => { setShowAddDialog(false); resetForm(); }} className="h-11"> Cancel </Button> <Button onClick={handleAddExpense} className="h-11"> Add Expense </Button> </div> </div> </DialogContent> </Dialog> )} </div> </CardHeader> <CardContent> <div className="space-y-6"> <div className="grid grid-cols-3 gap-4"> <Card> <CardContent className="pt-6"> <div className="text-sm text-black dark:text-white mb-1">Total Expenses</div> <div className="text-2xl font-bold">${totalExpenses.toLocaleString('en-US', { minimumFractionDigits: 2 })}</div> </CardContent> </Card> <Card> <CardContent className="pt-6"> <div className="text-sm text-black dark:text-white mb-1">Budget Remaining</div> <div className={`text-2xl font-bold ${budgetRemaining < 0 ? 'text-red-600' : 'text-green-600'}`}> ${Math.abs(budgetRemaining).toLocaleString('en-US', { minimumFractionDigits: 2 })} {budgetRemaining < 0 && ' over'} </div> </CardContent> </Card> <Card> <CardContent className="pt-6"> <div className="text-sm text-black dark:text-white mb-1">Budget Used</div> <div className={`text-2xl font-bold ${budgetPercentUsed > 100 ? 'text-red-600' : ''}`}> {budgetPercentUsed.toFixed(1)}% </div> </CardContent> </Card> </div> {Object.keys(expensesByCategory).length > 0 && ( <div> <h4 className="font-semibold mb-3">Expenses by Category</h4> <div className="grid grid-cols-2 gap-3"> {(Object.entries(expensesByCategory) as [MilestoneExpense['category'], number][]).map(([category, amount]) => { const Icon = categoryIcons[category] const percentage = (amount / totalExpenses) * 100 return ( <div key={category} className="flex items-center gap-3 p-3 border rounded-lg"> <Icon size={24} weight="duotone" /> <div className="flex-1"> <div className="text-sm font-medium capitalize">{category}</div> <div className="text-xs text-black dark:text-white">{percentage.toFixed(1)}% of total</div> </div> <div className="text-sm font-bold">${amount.toLocaleString('en-US', { minimumFractionDigits: 2 })}</div> </div> ) })} </div> </div> )} {expenses.length > 0 ? ( <div> <h4 className="font-semibold mb-3">Expense Details</h4> <div className="border rounded-lg overflow-hidden"> <Table> <TableHeader> <TableRow> <TableHead>Date</TableHead> <TableHead>Category</TableHead> <TableHead>Description</TableHead> <TableHead>Vendor</TableHead> <TableHead className="text-right">Qty</TableHead> <TableHead className="text-right">Unit Cost</TableHead> <TableHead className="text-right">Amount</TableHead> {canEdit && <TableHead className="w-16"></TableHead>} </TableRow> </TableHeader> <TableBody> {expenses.map((expense) => { const Icon = categoryIcons[expense.category] return ( <TableRow key={expense.id}> <TableCell className="whitespace-nowrap"> {new Date(expense.date).toLocaleDateString()} </TableCell> <TableCell> <Badge className={`${categoryColors[expense.category]} border`}> <Icon size={14} weight="bold" className="mr-1" /> {expense.category} </Badge> </TableCell> <TableCell> <div className="flex items-center gap-2"> {expense.description} {expense.receiptPhoto && ( <span title="Receipt attached"> <Receipt size={16} weight="fill" className="text-green-600" /> </span> )} </div> {expense.notes && ( <div className="text-xs text-black dark:text-white mt-1">{expense.notes}</div> )} </TableCell> <TableCell className="text-sm text-black dark:text-white"> {expense.vendor || '—'} </TableCell> <TableCell className="text-right"> {expense.quantity ? expense.quantity.toLocaleString() : '—'} </TableCell> <TableCell className="text-right"> {expense.unitCost ? `$${expense.unitCost.toLocaleString('en-US', { minimumFractionDigits: 2 })}` : '—'} </TableCell> <TableCell className="text-right font-semibold"> ${expense.amount.toLocaleString('en-US', { minimumFractionDigits: 2 })} </TableCell> {canEdit && ( <TableCell> <Button variant="ghost" size="sm" onClick={() => handleDeleteExpense(expense.id)} className="h-8 w-8 p-0" > <Trash size={16} weight="bold" className="text-red-600" /> </Button> </TableCell> )} </TableRow> ) })} </TableBody> </Table> </div> </div> ) : ( <div className="text-center py-8 text-black dark:text-white"> <Receipt size={48} weight="duotone" className="mx-auto mb-3 opacity-30" /> <p>No expenses tracked yet</p> {canEdit && ( <p className="text-sm mt-2">Click "Add Expense" to start tracking costs</p> )} </div> )} </div> </CardContent> </Card> </div> )
}
