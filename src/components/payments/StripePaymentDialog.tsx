import { useState } from 'react'
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Card, CardContent } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Separator } from '@/components/ui/separator'
import { CreditCard, Bank, Lock, CheckCircle, Warning } from '@phosphor-icons/react'
import { toast } from 'sonner'
import { calculatePaymentBreakdown, type PaymentBreakdown } from '@/lib/stripe'
import type { JobTier } from '@/lib/types' interface StripePaymentDialogProps { open: boolean onClose: () => void amount: number jobTitle: string jobId: string contractorName: string tier?: JobTier onPaymentComplete: (paymentId: string) => void
} export function StripePaymentDialog({ open, onClose, amount, jobTitle, jobId, contractorName, tier = 'STANDARD', onPaymentComplete
}: StripePaymentDialogProps) { const [paymentMethod, setPaymentMethod] = useState<'card' | 'ach'>('card') const [processing, setProcessing] = useState(false) const [cardNumber, setCardNumber] = useState('') const [expiry, setExpiry] = useState('') const [cvc, setCvc] = useState('') const [zipCode, setZipCode] = useState('') const [saveCard, setSaveCard] = useState(false) const breakdown: PaymentBreakdown = calculatePaymentBreakdown(amount, tier) const handlePayment = async () => { setProcessing(true) try { await new Promise<void>(resolve => setTimeout(resolve, 2000)) const paymentId = `pi_${Date.now()}_${Math.random().toString(36).substring(7)}` toast.success('Payment processed successfully!', { description: `$${breakdown.homeownerTotal.toFixed(2)} charged to your card` }) onPaymentComplete(paymentId) onClose() } catch (error) { toast.error('Payment failed', { description: 'Please check your card details and try again.' }) } finally { setProcessing(false) } } const formatCardNumber = (value: string) => { const v = value.replace(/\s+/g, '').replace(/[^0-9]/gi, '') const matches = v.match(/\d{4,16}/g) const match = (matches && matches[0]) || '' const parts: string[] = [] for (let i = 0, len = match.length; i < len; i += 4) { parts.push(match.substring(i, i + 4)) } if (parts.length) { return parts.join(' ') } else { return value } } const formatExpiry = (value: string) => { const v = value.replace(/\s+/g, '').replace(/[^0-9]/gi, '') if (v.length >= 2) { return v.substring(0, 2) + (v.length > 2 ? '/' + v.substring(2, 4) : '') } return v } return ( <Dialog open={open} onOpenChange={onClose}> <DialogContent className="overflow-hidden flex flex-col p-0 gap-0 h-[95vh]"> <div className="px-8 pt-6 pb-4 border-2 border-black dark:border-white flex-shrink-0"> <DialogHeader className="text-left"> <DialogTitle className="text-2xl">Complete Payment</DialogTitle> <DialogDescription> Secure payment powered by Stripe </DialogDescription> </DialogHeader> </div> <div className="flex-1 overflow-hidden p-6 grid grid-cols-1 lg:grid-cols-3 gap-6"> {/* Left Column - Payment Summary */} <div className="lg:col-span-1 space-y-4"> <Card className="border-primary/20 bg-primary/5"> <CardContent className="pt-6 space-y-4"> <div className="flex items-start justify-between"> <div> <h3 className="font-semibold text-base">{jobTitle}</h3> <p className="text-xs text-black dark:text-white mt-1">Job ID: {jobId}</p> <p className="text-xs text-black dark:text-white">Contractor: {contractorName}</p> </div> <Badge variant="outline" className="text-xs px-2 py-1"> {tier === 'QUICK_FIX' && 'üü¢ Quick Fix'} {tier === 'STANDARD' && 'üü° Standard'} {tier === 'MAJOR_PROJECT' && 'üîµ Major Project'} </Badge> </div> <Separator /> <div className="space-y-2 text-sm"> <div className="flex items-center justify-between"> <span className="text-black dark:text-white">Job Amount</span> <span className="font-semibold">${breakdown.jobAmount.toFixed(2)}</span> </div> <div className="flex items-center justify-between"> <span className="text-black dark:text-white">Platform Fee</span> <span className="text-sm">${breakdown.platformFee.toFixed(2)}</span> </div> <Separator /> <div className="flex items-center justify-between text-lg font-bold"> <span>Total</span> <span>${breakdown.homeownerTotal.toFixed(2)}</span> </div> </div> <div className="flex items-start gap-2 p-3 bg-background rounded-lg border"> <CheckCircle className="text-primary flex-shrink-0 mt-0.5" size={16} weight="fill" /> <div className="text-xs text-black dark:text-white"> <p className="font-medium text-black dark:text-white mb-1">Contractor receives full amount</p> <p>The contractor will receive ${breakdown.contractorPayout.toFixed(2)} - we don't take a cut from their earnings.</p> </div> </div> </CardContent> </Card> <div className="flex items-start gap-2 p-4 bg-muted/50 rounded-lg"> <Lock className="text-black dark:text-white flex-shrink-0 mt-0.5" size={16} weight="fill" /> <div className="text-xs text-black dark:text-white space-y-1"> <p className="font-medium text-black dark:text-white">Secure Payment</p> <p>Your payment information is encrypted and secure. We never store your full card details.</p> </div> </div> </div> {/* Right Column - Payment Form */} <div className="lg:col-span-2 space-y-4"> <div className="flex gap-2"> <Button type="button" variant={paymentMethod === 'card' ? 'default' : 'outline'} className="flex-1 h-11" onClick={() => setPaymentMethod('card')} > <CreditCard className="mr-2" size={18} weight="fill" /> Credit/Debit Card </Button> <Button type="button" variant={paymentMethod === 'ach' ? 'default' : 'outline'} className="flex-1 h-11" onClick={() => setPaymentMethod('ach')} > <Bank className="mr-2" size={18} weight="fill" /> Bank Transfer (ACH) </Button> </div> {paymentMethod === 'card' ? ( <div className="space-y-4"> <div className="space-y-2"> <Label htmlFor="cardNumber" className="text-base">Card Number</Label> <div className="relative"> <Input id="cardNumber" placeholder="1234 5678 9012 3456" value={cardNumber} onChange={(e) => setCardNumber(formatCardNumber(e.target.value))} maxLength={19} className="h-11 text-base" /> <CreditCard className="absolute right-3 top-1/2 -translate-y-1/2 text-black dark:text-white" size={20} /> </div> </div> <div className="grid grid-cols-3 gap-4"> <div className="space-y-2"> <Label htmlFor="expiry" className="text-sm">Expiry</Label> <Input id="expiry" placeholder="MM/YY" value={expiry} onChange={(e) => setExpiry(formatExpiry(e.target.value))} maxLength={5} className="h-11" /> </div> <div className="space-y-2"> <Label htmlFor="cvc" className="text-sm">CVC</Label> <Input id="cvc" placeholder="123" value={cvc} onChange={(e) => setCvc(e.target.value.replace(/\D/g, '').substring(0, 4))} maxLength={4} className="h-11" /> </div> <div className="space-y-2"> <Label htmlFor="zipCode" className="text-sm">ZIP Code</Label> <Input id="zipCode" placeholder="12345" value={zipCode} onChange={(e) => setZipCode(e.target.value.replace(/\D/g, '').substring(0, 5))} maxLength={5} className="h-11" /> </div> </div> <div className="flex items-center gap-2"> <input type="checkbox" id="saveCard" checked={saveCard} onChange={(e) => setSaveCard(e.target.checked)} className="rounded border-border w-4 h-4" /> <Label htmlFor="saveCard" className="text-sm cursor-pointer"> Save card for future payments </Label> </div> </div> ) : ( <Card className="border-dashed"> <CardContent className="pt-6 text-center space-y-4"> <Bank size={48} className="mx-auto text-black dark:text-white" weight="fill" /> <div className="space-y-2"> <h4 className="font-semibold">Bank Transfer (ACH)</h4> <p className="text-sm text-black dark:text-white"> Connect your bank account for lower fees (0.8% vs 2.9%) </p> </div> <Button variant="outline" className="w-full h-11"> Connect Bank Account </Button> <p className="text-xs text-black dark:text-white"> Bank transfers take 3-5 business days to process </p> </CardContent> </Card> )} </div> </div> <div className="px-8 py-4 border-2 border-black dark:border-white flex-shrink-0"> <div className="flex gap-3"> <Button type="button" variant="outline" onClick={onClose} disabled={processing} className="flex-1 h-11" > Cancel </Button> <Button onClick={handlePayment} disabled={processing || (paymentMethod === 'card' && (!cardNumber || !expiry || !cvc || !zipCode))} className="flex-1 h-11" > {processing ? ( <> <span className="inline-block animate-spin mr-2">‚è≥</span> Processing... </> ) : ( <> <Lock className="mr-2" size={18} weight="fill" /> Pay ${breakdown.homeownerTotal.toFixed(2)} </> )} </Button> </div> </div> </DialogContent> </Dialog> )
}
